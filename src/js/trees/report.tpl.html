<div ng-controller="ReportCtrl" class='ReportCtrl div_{{routeParams.stateID}} padding-top-none'>

<!-- LOAD recent estimates list -->
<div ng-if="data.mode()=='trees' && !auth.is('customer')" style="margin-bottom: 15px;">
    <select title="Load Estimate" id="reportSelector" class="styled-select" ng-model="rdata.recentReportID">
        <option value="">Recent Estimates</option>
		<!-- todo-bindonce - was removed from here: "bindonce bo-value="r.reportID"" ... repalce this back
			if we can get the rebinder working -->
        <option bindonce bo-value="r.reportID" ng-repeat="r in recentReportList" ng-bind="getRecentReportTitle(r)">
        </option>
    </select>
    <BR><BR>
    <button class="btn btn-blue clr-white" ng-cloak ng:show="report.items.length>0" ng-click="newReport();">New Report</button>
</div>

<div class="touch-boundry">
	<div ng-include="'js/trees/action.tpl.html'" ng-if="data.mode()=='estimate' && auth.is('customer')"></div>
</div>	

<!--BEGIN ESTIMATE TABLE SECTION-->
<div bindonce="report" class="table_estimate estimate-container report_main mode_{{data.mode()}}" ng-if="report.items.length>0">
	<div class="estimate-summary">
		<div class="row row-estimate">
			<div class="col-md-6 col">
				<div class="estimate-info">
					<dl class="small">
						<dt>Created: </dt>
						<dd ng-bind="report.tstamp_updated"></dd>
					</dl>
					<h1 class="title" bo-text="'Estimate for ' + report.siteName"></h1>
					<p class="name">
						<span ng-if="data.mode()=='trees'">
							<a href editable-text='report.name' class='reportName'>{{report.name}}</a> &nbsp;
						</span>
						<span ng-if="data.mode()!='trees'">
							{{report.name}}
						</span>
					</p>	
					<dl>
						<dt>Estimate ID: </dt>
						<dd ng-bind="report.reportID"></dd>
					</dl>
					<dl>	
						<dt>Contact: </dt>
						<dd ng-bind="report.contact + ' ' + report.contactPhone"></dd>
					</dl>
					<dl>	
						<dt>Address: </dt>
						<dd ng-bind="report.street + ', ' + report.city + ',' + report.state + ' ' + report.zip"></dd>
					</dl>
				</div>	
			</div>
			<div class="col-md-2 col">
				<div class="estimate-info">
					<p class="name">Sales Representative</p>
					<dl>
						<dt>Name: </dt>
						<dd>John Doe</dd>
					</dl>
					<dl>	
						<dt>Email: </dt>
						<dd>john@doe.com</dd>
					</dl>
					<dl>	
						<dt>Phone: </dt>
						<dd>121221245212</dd>
					</dl>
				</div>
			</div>
			<div class="col-md-4 col">
				<div class="bid-info">
					<div class="logos">
						<span class="logo"><img src="img/logo_tcia.png"></span>
						<span class="logo"><img src="img/logo_wcisa.png"></span>
						<span class="logo"><img src="img/logo_ctsp.png"></span>
						<span class="logo"><img src="img/logo_papa.jpg"></span>
						<span class="logo"><img src="img/logo_treeworker.jpg"></span>
						<span class="logo"><img src="img/logo_bcma.jpg"></span>
					</div>
					<p class="bid">Total Bid: ${{report.total.grand|formatPrice}}</p>
				</div>
			</div>		
		</div>	
	</div>
	
	<div class="estimate-actions" ng-if="data.mode()=='trees'">
		<button class="btn btn-red clr-white" ng-click="saveReport()">Save</button>
		<button class="btn btn-red clr-white" 
				data-backdrop='static'
				data-keyboard=true
				bs-modal
				data-template="js/trees/emailReport.tpl.html"
				ng-click="initEmailModal()"
				>Send</button>
		<a ng-if='report.reportLink' href='{{report.reportLink}}' target='_cust_view'
			onclick='return confirm("This will log you out. Continue?\n(Alternatively, you can copy and paste this into a completely different browser)");'>Customer View</a> 
		<div class="clearfix"></div>
	</div>	 

	<!-- Email logs -->
	 <div ng-if="report.emailLogs && report.emailLogs.length && data.mode()=='trees'">
		Email logs:<BR>
		<table class='table ng-table-responsive ng-table'>
			<tr bindonce ng-table ng-repeat="itm in report.emailLogs">
				<td>{{itm.senderEmail}} <i class='fa fa-arrow-right'></i> {{itm.recipientEmail}}
				&nbsp; <a ng-if="itm.link" target='new' href='{{itm.link}}'>link</a>
				</td>
				<td bo-text="itm.tstamp_sent || ''"></td>
				<td>
					<span ng-show="itm.resultMessage" ng-class="'emaillogResult '+itm.resultMessage" ng-bind='itm.resultMessage'></span>
				</td>
			</tr>
		</table>
	</div>
     
   	<div class="table-container">
   		<div class="row row-table">
   			<div class="col-md-4" ng-if="data.mode()=='estimate'">
   				<div id="treeMap_estimate" class="map-container mode_{{data.mode()}}">
					<div id="treeMap2" class="mode_{{data.mode()}}"></div>
				</div>
   			</div>
   			<div class="col-md-8 col-info-{{data.mode()}}">
   				<div class="table-responsive">
				   	<table class="table table-striped table-bordered table-hover ng-scope ng-table mode_{{data.mode()}}">
				   		<thead>
							<tr id="estimate_table_heading">
						       <td class="td-image">Tree</td>
						       <td class="td-id">ID</td>
						       <td class="td-name">Name</td>
						       <td class="td-treatment">Treatment</td>
						       <td class="td-bid">Bid ($)</td>
						       <td class="td-action"></td>
							</tr>
						</thead>
						<tbody>
							<!-- todo-bindonce - i removed it from below... cuz it broke editing of values... 
								if we can get rebind to work, then we need to rebind if the user is an admin (and they want to edit)
								and leave bindonce if the user is a customer t-->
							<tr ng-repeat="item in groupedItems" ng-if="report.items.length>0"
								ng-init="itemIndex = $index"
								ng-class="rowHighlightClass(item)"
								ng-mouseover="hover=true" ng-mouseleave="hover=false" id="rpt_item_{{item.treeID}}">
				                <td data-title="listing_image" class="td-image">
									<img bo-src='item.imgSm + tree_cachebuster' class='item_thumb'
										data-placement="right"
										data-trigger="hover"
										data-content="<img style='width:100%; height:auto;' src='{{item.imgMed}}{{tree_cachebuster}}'>"
										data-html="true"
										bs-popover
										style="border:3px solid #{{colors.bg[item.colorID]}} !important"
									/>
								</td>
				                <td data-title="listing_ID" class="td-id">{{item.localTreeID}}</td>
				                <td data-title="listing_species" class="td-name">
                    				{{item.dbhID | dbhID2Name:this }}
									{{item.commonName || 'Not specified'}} <span ng-if="item.botanicalName">({{item.botanicalName}})</span>
									<span class="light" bo-text="'[' + item.treeID + ']'"></span>
									<div ng-if="item.notes" id="estimate_table_notes">{{item.notes}}</div>
								</td>
				                <td data-title="listing_treatment" colspan="3" class="td-treatment-bid">
									<table class="">
			 							<tr ng-repeat="treatment in item.treatments" ng-init="treatmentIndex = $index">
											<td ng-if="auth.isAtleast('inventory') && !auth.is('customer')" data-title="listing_treatment" class="td-treatment">
												<a href e-ng-options="obj.code as obj.treatmentType for obj in initData.filters.treatments"
												   editable-select="treatment.treatmentTypeCode"
												   onshow="onShowEditItem(item.$$hashKey)"
												   onhide="onHideEditItem()">
													{{treatment.treatmentTypeCode|treatmentTypeCode2Name:this}}
												</a>
											</td>
                                            <td ng-if="auth.is('customer')">
                                                <span ng-bind="treatment.treatmentTypeCode|treatmentTypeCode2Name:this">
                                                </span>
                                            </td>
											<td ng-if="auth.isAtleast('inventory') && !auth.is('customer')" data-title="listing_price" class="td-bid">
												&#36;<a href editable-text='treatment.price' onshow="onShowEditItem(item.$$hashKey)" onhide="onHideEditItem()">{{treatment.price|formatPrice}}</a>
											</td>
                                            <td ng-if="auth.is('customer')">
                                                <span ng-bind="treatment.price|formatPrice"></span>
                                            </td>

											<td data-title="listing_options" class="td-action">
												<a href='#/tree_edit/{{item.treeID}}' class='row-action' ng-if="auth.isAtleast('inventory')">
                                                    <i class="fa fa-pencil clr-primary"></i>
                                                </a>
												<a href ng-click="removeTreatmentFromEstimate(itemIndex, treatmentIndex)" class='row-action' ng-if="auth.is('admin')">
                                                    <i class="fa fa-times clr-danger"></i>
                                                </a>
											</td>
										</tr>
									</table>
				                </td>	<!-- }}} listing_treatment colspan=3 -->
				            </tr>
							<tr ng-if="report.total.items && data.mode()=='trees'">
								<td colspan="4" class="td-bid">Subtotal:</td>
								<td class="td-bid">&#36;{{report.total.items|formatPrice}}</td>
								<td>&nbsp;</td>
							</tr> 
						</tbody>		
				   	</table>
				</div>



				<div class="table-responsive">
				   	<table class="table ng-scope ng-table" ng-if="data.mode()=='trees' || report.services.length > 0 ">
				   		<thead>
							<tr>
								<td colspan="4">Misc. Services</td>
							</tr>
							<tr>
								<td colspan="{{ data.mode()=='trees' && '1' || '2' }}">Description</td>
								<td>Quantity</td>
								<td class="text-right">Price</td>
								<td ng-if="data.mode()=='trees'"></td>
							</tr>
						</thead>
   						
   						<tbody>
                        <tr ng-repeat="item in report.services" class="hoverHotspot">							   	<td data-title="service_desc" colspan="{{ data.mode()=='trees' && '1' || '2' }}">
									<a href editable-text='item.desc' ng-if='auth.isAtleast("inventory")'>{{item.desc}}</a>
									<span ng-if='!auth.isAtleast("inventory")'>{{item.desc}}</span>
								</td>
								<td data-title="service_quantity">
									<a href editable-text='item.quantity' ng-if='auth.isAtleast("inventory")'>{{item.quantity}}</a>
									<span ng-if='!auth.isAtleast("inventory")'>{{item.quantity}}</span>
								</td>
								<td data-title="service_price" class="text-right">
									<a href editable-text='item.price' ng-if='auth.isAtleast("inventory")'>{{item.price}}</a>
									<span ng-if='!auth.isAtleast("inventory")'>{{item.price}}</span>
								</td>
								<td ng-if="data.mode()=='trees'">
									<div ng-if="auth.isAtleast('inventory')">
										<a href ng-click="removeItem(item.$$hashKey,'services')"
											 class='fa fa-times _red _med hoverDisplay' ></a>
									</div>
								</td>
							</tr>

						   	<tr ng-if="data.mode()=='trees'">
								<td>
									<textarea ng-model="service.desc" class="rightMargin10" placeholder="Service Description" style='width:490px;height:2em;'></textarea>
								</td>
								<td>
									<span>
										x&nbsp;<input type="text" ng-model="service.quantity" class="rightMargin10" placeholder="1" style='width:30px;height:2em;' ng-init="service.quantity=1"></input>
									</span>
								</td>
								<td style="padding-left:0px;padding-right:0px"  class="text-right">
									<span>
										$&nbsp;<input type="text" ng-model="service.price"  placeholder="0.00" style='width:40px;height:2em;'></input>
									</span>
								</td>
								<td class="text-right">
						   			<button class="btn btn-red clr-white" ng-click="addMiscService(service.desc,service.quantity,service.price)">ADD</button>
						   		</td>
						   	</tr>

							<!-- // Subtotals // -->
							<tr ng-if="report.total.services">
								<td align=right colspan="3">Misc Services Subtotal:</td>
								<td class="text-right">&#36;{{report.total.services|formatPrice}}</td>
							</tr>
							<tr ng-if="report.total.services">
								<td align=right colspan="3">Tree Services Subtotal:</td>
								<td class="text-right">&#36;{{report.total.items|formatPrice}}</td>
							</tr>
						</tbody>	
   					</table>   					
				</div>

				<div class="total-amount">
					Total: &#36;{{report.total.grand|formatPrice}}
				</div>

				<div class="section-container" ng-if="data.mode()=='trees'">
			   		<h6 class="section-sub-title">Notes</h6>
			        <textarea ckeditor="editorOptions" ng-model="report.notes" placeholder="Notes" style='width:100%;height:100px;'></textarea>
			     </div>
			     
			 	<div class="section-container" ng-if="data.mode()=='estimate'">
			 		<h6 class="section-sub-title">Notes</h6>
			        <span ng-bind-html="report.notes"></span>

					<h2 class="section-mini-title">Definition of Treatments:</h2>
					<div ng-repeat=" desc in treatmentDescriptions "> 
						<p><b>{{desc.treatmentType}}</b> - {{desc.desc}}</p>
					</div>
			   	</div>
			   	
   			</div>
   		</div>
   	</div>
   	
   	
	</div>



<!--
=======






<table class="table ng-table-responsive ng-scope ng-table" ng-if="data.mode()=='trees' || report.services.length>0 ">
    <tr><td colspan="4"><h1>Misc. Services</h1></td></tr>

    <tr>
        <th>Description</th>
        <th>Quantity</th>
        <th>Price</th>
        <th>Subtotal</th>
        <td> &nbsp; &nbsp; </td>
    </tr>

    <tr ng-repeat="item in report.services"
        ng-mouseover="hover=true" ng-mouseleave="hover=false">
        <td data-title="service_desc"><a href editable-text='item.desc'>{{item.desc}}</a></td>
        <td data-title="service_quantity"><a href editable-text='item.quantity'>{{item.quantity}}</a></td>
        <td data-title="service_price"><a href editable-text='item.price'>{{item.price}}</a></td>
        <td ng-bind="(item.price * item.quantity) | formatPrice"></td>
        <td ng-if="data.mode()=='trees'" width='50px;'>
            <a ng-show="hover" href ng-click="removeItem(item.$$hashKey,'services')" class='fa fa-times _red _med' ></a>
        </td>
    </tr>

    <tr ng-if="data.mode()=='trees'">
        <td>
            <textarea ng-model="service.desc" class="rightMargin10" placeholder="Service Description" style='width:490px;height:2em;'></textarea>
        </td>
        <td>
		<span>
		x<input type="text" ng-model="service.quantity" class="rightMargin10" placeholder="1" style='width:30px;height:2em;' ng-init="service.quantity=1"></input>
		</span>
        </td>
        <td style="padding-left:0px;padding-right:0px">
		<span>
		$<input type="text" ng-model="service.price"  placeholder="0.00" style='width:40px;height:2em;'></input>
		</span>
        </td>
        <td>
            <span ng-bind="(service.price || 0) * service.quantity | formatPrice"></span>
        </td>
        <td>
            <button class="navButton width90 roundedCorners" ng-click="addMiscService(service.desc,service.quantity,service.price)">ADD</button>
        </td>
    </tr>

    <tr ng-if="report.total.services">
        <td align=right colspan="4">Misc Services Subtotal:</td>
        <td>&#36;{{report.total.services|formatPrice}}</td>
    </tr>
    <tr ng-if="report.total.services">
        <td align=right colspan="4">Tree Services Subtotal:</td>
        <td>&#36;{{report.total.items|formatPrice}}</td>
    </tr>
</table>

<div style='text-align:right; font-weight:bold; font-size:1.2em;'>
    Total: &#36;{{report.total.grand|formatPrice}}
</div>


<div class="" ng-if="data.mode()=='trees'">
    <p><span style='font-size:130%;'>Notes</span> (currently image uploads are not avaiable)</p>
    <textarea ckeditor="editorOptions" ng-model="report.notes" class="styled_input" placeholder="Notes" style='width:80%;height:8em;'>
    </textarea>
</div>

<div class="" ng-if="data.mode()=='estimate'">
    <h2>Notes</h2>
    <span ng-bind-html="report.notes"></span>

    <h2>Definition of Treatments:</h2>
    <div ng-repeat=" desc in treatmentDescriptions ">
        <p><b>{{desc.treatmentType}}</b> - {{desc.desc}}</p>
    </div>
</div>

<div class ="bottomSpace10"></div>
</div>
>>>>>>> tim/38_hussain_css_merge_to_master
-->




</div> <!-- }}} .report_main -->

<div style='margin:15px 0 60px 70px; font-size:130%; color:#555;' class="" ng-if="report.items.length<1">
    (No Trees Added to Estimate Yet)
</div>


</div> <!-- }}} ReportCtrl -->

<div class = "clearfloat"></div>
