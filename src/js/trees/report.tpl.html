<div ng-controller="ReportCtrl" class='ReportCtrl div_{{routeParams.stateID}}'>



<!-- LOAD recent estimates list -->
<div class="pullleft width180" ng-if="data.mode()=='trees'">
    <select title="Load Estimate" id="reportSelector" class="styled-select" ng-model="rdata.recentReportID">
		<option value="">Recent Estimates</option>
    	<option ng-repeat="r in recentReportList" value="{{r.reportID}}">{{r.name}} - {{r.tstamp_updated}}</option>
    </select>
	<BR><BR>
	<button ng-cloak ng:show="report.items.length>0" ng-click="newReport();">New Report</button>
</div>

    
     
      
<div class="action-container" id="action-container">
	<div class="row row-action">
		<div class="col-sm-2 col">
			<div class="action-block action-block-1">
				<a href="#" class="btn btn-lg btn-red">HOME</a>
			</div>
		</div>
		<div class="col-sm-4 col">
			<div class="action-block">
				<ul class="stats list-unstyled list-inline row">
					<li class="col-xs-4">
						<div class="stat">
							<p class="number">4</p>
							<p class="text">Estimates</p>
						</div>
					</li>
					<li class="col-xs-4">
						<div class="stat">
							<p class="number">6</p>
							<p class="text">Properties</p>
						</div>
					</li>
					<li class="col-xs-4">
						<div class="stat">
							<p class="number">317</p>
							<p class="text">Trees</p>
						</div>
					</li>
				</ul>
			</div>
		</div>
		<div class="col-sm-6 col">
			<div class="action-block no-border action-block-3">
				<div class="row row-xs">
					<div class="col-xs-4 col">
						<a href="#" class="btn btn-xs btn-block btn-blue"><i class="fa fa-arrow-down"></i> Download</a>
					</div>
					<div class="col-xs-4 col">
						<a href="#" class="btn btn-xs btn-block btn-orange"><i class="fa fa-times"></i> Request Changes</a>
					</div>
					<div class="col-xs-4 col">
						<a href="#" class="btn btn-xs btn-block btn-green"><i class="fa fa-check"></i> Approve Estimate</a>
					</div>
				</div>
			</div>
		</div>
		<div class="clearfix"></div>
	</div>
</div>  


<!--BEGIN ESTIMATE TABLE SECTION-->
<div class="table_estimate estimate-container report_main mode_{{data.mode()}}" ng-if="report.items.length>0">
	<div class="estimate-summary">
		<div class="row row-estimate">
			<div class="col-md-8 col">
				<div class="estimate-info">
					<dl class="small">
						<dt>Created: </dt>
						<dd>{{report.tstamp_updated}}</dd>
					</dl>
					<h1 class="title">Estimate for {{report.siteName}}</h1>
					<p class="name">
						<span ng-if="data.mode()=='trees'">
							<a href editable-text='report.name' class='reportName'>{{report.name}}</a> &nbsp;
						</span>
						<span ng-if="data.mode()!='trees'">
							{{report.name}}
						</span>
					</p>	
					<dl>
						<dt>Estimate ID: </dt>
						<dd>{{report.reportID}}</dd>
					</dl>
					<dl>	
						<dt>Contact: </dt>
						<dd>{{report.contact}} ({{report.contactPhone}})</dd>
					</dl>
					<dl>	
						<dt>Address: </dt>
						<dd>{{report.street}}, {{report.city}},{{report.state}} {{report.zip}}</dd>
					</dl>
				</div>	
			</div>
			<div class="col-md-4 col">
				<div class="bid-info">
					<p class="bid">Total Bid: ${{report.total.grand|formatPrice}}</p>
				</div>
			</div>		
		</div>	
	</div>
	
	<div ng-if="data.mode()=='trees'">
		<div class = "clearfloat"></div>
		<div class="inlineBlock pullleft">
			 <div class="inline pullleft rightSpace20">

				<button class="navButton width180 roundedCorners" ng-click="saveReport()">Save</button>
				<button class="navButton width180 roundedCorners" 
						data-backdrop='static'
						data-keyboard=true
						bs-modal
						data-template="js/trees/emailReport.tpl.html"
						ng-click="initEmailModal()"
						>Send</button>
				<a href='{{report.reportLink}}' target=_new>Customer View</a> 

			 </div>
			 <div class="clearfloat"></div>

		 </div>
		 <div class = "clearfloat"></div>
	</div>	 

	<!-- Email logs -->
	 <div ng-if="report.emailLogs && data.mode()=='trees'">
		Email logs:<BR>
		<table class='table ng-table-responsive ng-table'>
			<tr ng-table ng-repeat="itm in report.emailLogs">
				<td>{{itm.senderEmail}} <i class='fa fa-arrow-right'></i> {{itm.recipientEmail}}
				&nbsp; <a ng-if="itm.link" target='new' href='{{itm.link}}'>link</a>
				</td>
				<td>{{itm.tstamp_sent}}</td>
				<td>
					<span class='textIconBlock-green' ng-if="itm.tstamp_opened">OPENED</span>
					<span class='textIconBlock-red' ng-if="itm.result!=1 && !itm.tstamp_opened">SEND FAILED</span>
				</td>
			</tr>
		</table>
	</div>
     
   	<div class="table-container">
   		<div class="row row-table">
   			<div class="col-md-3">
   				<div id="treeMap_estimate" class="map-container mode_{{data.mode()}}" ng-if="data.mode()=='estimate'">
					<div id="treeMap2" class="mode_{{data.mode()}}"></div>
				</div>
   			</div>
   			<div class="col-md-9">
   				<div class="table-responsive">
				   	<table class="table table-striped table-bordered table-hover ng-scope ng-table mode_{{data.mode()}}">
				   		<thead>
							<tr id="estimate_table_heading">
						       <td ng-if="data.mode()=='trees'">Tree</td>
						       <td>ID</td>
						       <td>Name</td>
						       <td ng-if="data.mode()=='trees'">Size</td>
						       <td>Treatment</td>
						       <td ng-if="data.mode()=='trees'">Price</td>
						       <td ng-if="data.mode()=='trees'"></td>
						       <td ng-if="data.mode()=='trees'">Rating</td>
						       <td ng-if="data.mode()=='estimate'" class="amount">Bid ($)</td>
							</tr>
						</thead>
						<tbody>
					    	<tr ng-table ng-repeat="item in report.items" ng-if="report.items.length>0"
				            	ng-class="rowHighlightClass(item)"
								ng-mouseover="hover=true" ng-mouseleave="hover=false" id="rpt_item_{{item.$$hashKey}}">
				                <td data-title="listing_image">

										<!--data-template="js/trees/treeRollover.tpl.html"-->

									<img ng-src='{{item.imgSm}}{{tree_cachebuster}}' class='item_thumb'
										data-placement="right"
										data-trigger="hover"
										data-content="<img style='width:320px; height:auto;' src='{{item.imgMed}}{{tree_cachebuster}}'>"
										data-html="true"
										bs-popover
										style="border:3px solid #{{colors.bg[item.colorID]}} !important"
									/>
								</td>
				                <td data-title="listing_ID">{{item.localTreeID}}</td>
				                <td data-title="listing_species">
									{{item.commonName || 'Not specified'}} <span ng-if="item.botanicalName">({{item.botanicalName}})</span>
									<span class="light">[{{item.treeID}}]</span>
									<div ng-if="item.notes" id="estimate_table_notes">{{item.notes}}</div>
								</td>
				                <td ng-if="data.mode()=='trees'">
				                    {{item.dbhID | dbhID2Name:this }}
								</td>
				                <td ng-if="data.mode()=='estimate'" data-title="treatment_yearAndType">
								  {{item.treatmentTypeCode | getTreatmentTypeName:this}}
				                </td>
				                <td ng-if="data.mode()=='trees'" data-title="listing_rating">
				                  {{item.ratingID | treeRatingGetter:this}}
				                </td>
				                <td data-title="listing_dbh" ng-if="data.mode()=='trees'">
				                    {{item.dbhID | dbhID2Name:this }}
				                </td>
				                <td data-title="listing_treatment" ng-if="data.mode()=='trees'">
									<a href e-ng-options="obj.code as obj.treatmentType for obj in initData.filters.treatments" 
										editable-select="item.treatmentTypeCode"
										onshow="onShowEditItem(item.$$hashKey)"
										onhide="onHideEditItem()">
											{{item.treatmentTypeCode|treatmentTypeCode2Name:this}}
									</a>
				                </td>
				                <td ng-if="data.mode()=='trees'" data-title="listing_price">&#36;
				                    <a href editable-text='item.price' onshow="onShowEditItem(item.$$hashKey)">
				                        {{item.price|formatPrice}}
				                    </a>
				                </td>
				                <td ng-if="data.mode()=='trees'" data-title="listing_options" width='55px;'>
				            		<a ng-show="hover" href='#/tree-edit/{{item.treeID}}' class='fa fa-pencil _grey _med'></a> &nbsp;
				                    <a ng-show="hover" href ng-click="removeItem(item.$$hashKey,'items')" class='fa fa-times _red _med' ></a>
				                </td>
				                <td ng-if="data.mode()=='estimate'" data-title="listing_bid" class="amount">
				               		&#36;{{item.price|formatPrice}}
				                </td>
				            </tr>
							<tr ng-if="report.total.items && data.mode()=='trees'">
								<td colspan=4></td><td>Subtotal:</td>
								<td>&#36;{{report.total.items|formatPrice}}</td>
								<td>&nbsp;</td>
							</tr> 
							<!-- 
							<tr ng-if="report.total.items && data.mode()=='estimate'">
								<td colspan=7></td>
								<!-- Commenting out for now as per mocks.
								<td colspan=5></td><td>Subtotal:</td>
								<td>&#36;{{report.total.items|formatPrice}}</td>
								
							</tr> 
							-->
						</tbody>		
				   	</table>
				</div>
				<div class="table-responsive">
				   	<table class="table ng-scope ng-table" ng-if="data.mode()=='trees' || report.services.length > 0 ">
				   		<thead>
							<tr>
								<td colspan="4">Misc. Services</td>
							</tr>
							<tr>
								<td>Description</td>
								<td>Quantity</td>
								<td>Price</td>
								<td></td>
							</tr>
						</thead>
   						
   						<tbody>
							<tr ng-repeat="item in report.services" 
								ng-mouseover="hover=true" ng-mouseleave="hover=false">
							   	<td data-title="service_desc">
									<a href editable-text='item.desc' ng-if='auth.is("staff")'>{{item.desc}}</a>
									<span ng-if='!auth.is("staff")'>{{item.desc}}</span>
								</td>
								<td data-title="service_quantity">
									<a href editable-text='item.quantity' ng-if='auth.is("staff")'>{{item.quantity}}</a>
									<span ng-if='!auth.is("staff")'>{{item.quantity}}</span>
								</td>
								<td data-title="service_price">
									<a href editable-text='item.price' ng-if='auth.is("staff")'>{{item.price}}</a>
									<span ng-if='!auth.is("staff")'>{{item.price}}</span>
								</td>
								<td>
									<div ng-if="auth.is('staff') && data.mode=='trees'">
											<a ng-show="hover" href ng-click="removeItem(item.$$hashKey,'services')" 
												class='fa fa-times _red _med' ></a>
									</div>
								</td>
							</tr>

						   	<tr ng-if="data.mode()=='trees'">
								<td>
									<textarea ng-model="service.desc" class="rightMargin10" placeholder="Service Description" style='width:490px;height:2em;'></textarea>
								</td>
								<td>
									<span>
										x<input type="text" ng-model="service.quantity" class="rightMargin10" placeholder="1" style='width:30px;height:2em;' ng-init="service.quantity=1"></input>
									</span>
								</td>
								<td style="padding-left:0px;padding-right:0px">
									<span>
										$<input type="text" ng-model="service.price"  placeholder="0.00" style='width:40px;height:2em;'></input>
									</span>
								</td>
								<td>
						   			<button class="navButton width90 roundedCorners" ng-click="addMiscService(service.desc,service.quantity,service.price)">ADD</button>
						   		</td>
						   	</tr>

							<!-- // Subtotals // -->
							<tr ng-if="report.total.services">
								<td align=right colspan="3">Misc Services Subtotal:</td>
								<td>&#36;{{report.total.services|formatPrice}}</td>
							</tr>
							<tr ng-if="report.total.services">
								<td align=right colspan="3">Tree Services Subtotal:</td>
								<td>&#36;{{report.total.items|formatPrice}}</td>
							</tr>
						</tbody>	
   					</table>   					
				</div>

				<div class="total-amount">
					Total: &#36;{{report.total.grand|formatPrice}}
				</div>
   			</div>
   		</div>
   	</div>
   	
   	<div class="section-container" ng-if="data.mode()=='trees'">
   		<h6 class="section-sub-title">Notes</h6>
        <textarea ng-model="report.notes" class="styled_input" placeholder="Notes" style='width:80%;height:8em;'></textarea>
     </div>
     
 	<div class="section-container" ng-if="data.mode()=='estimate'">
 		<h6 class="section-sub-title">Notes</h6>
        <pre>{{report.notes}}</pre>

		<h2 class="section-mini-title">Definition of Treatments:</h2>
		<div ng-repeat=" desc in treatmentDescriptions "> 
			<p><b>{{desc.treatmentType}}</b> - {{desc.desc}}</p>
		</div>
   	</div>
	</div>
</div> <!-- }}} .report_main -->

<div style='margin:15px 0 60px 70px; font-size:130%; color:#555;' class="" ng-if="report.items.length<1">
	(No Trees Added to Estimate Yet)	
</div>


</div> <!-- }}} ReportCtrl -->

<div class = "clearfloat"></div>
